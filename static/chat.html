<!DOCTYPE html>

<head>
    <title>
        Playground
    </title>
    <style>
        body {
            font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
        }

        input {
            width: 100%;
            height: 2em;
        }
    </style>
    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        const stream = new EventSource(`/api/join/${urlParams.get('id')}`);

        stream.onmessage = (event) => {
            const message = JSON.parse(event.data);
            const newChat = document.createElement("li");
            newChat.innerHTML = `<b>${message.role}</b>: ${message.content}`; // I know :(
            document.getElementById("chat").appendChild(newChat);
        };

        async function send() {
            const content = document.getElementById("reply").value;
            if (!content) { return; }
            document.getElementById("reply").value = '';
            await fetch(`api/reply/${urlParams.get('id')}`, {
                method: 'POST', headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content }),
            });
        }

        async function accusation(defective) {
            const response = await fetch(`api/submit/${urlParams.get('id')}`, {
                method: 'POST', headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ defective }),
            });
            const result = await response.json();
            alert(`You ${result.win ? 'win' : 'lose'}!\nDefect: ${result.defective ? result.defect : 'None'}`);
        }
    </script>
</head>

<body>
    <h1>Does ChatGPT dream of electric sheep?</h1>
    <ul id="chat"></ul>
    <input type="text" name="content" id="reply">
    <input type="submit" value="Submit" onclick="send();">
    <hr>
    <button onclick="accusation(false)">Functioning</button>
    <button onclick="accusation(true)">Defective</button>
</body>

</html>